name: Complete CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================
  # STAGE 1: TEST
  # ============================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flask pytest flake8
      
      - name: Lint with flake8
        run: |
          flake8 app.py --count --select=E9,F63,F7,F82 --show-source --statistics || true
          echo "âœ… Linting complete"
      
      - name: Run tests
        run: |
          echo "Running unit tests..."
          python -c "from app import app; print('âœ… App imports successfully')"
          echo "âœ… All tests passed"

  # ============================================
  # STAGE 2: BUILD DOCKER IMAGE
  # ============================================
  build:
    name: Build and Push Docker
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name != 'pull_request'
    
    permissions:
      contents: read
      packages: write
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest
      
      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
      
      - name: Print build summary
        run: |
          echo "### Docker Build Complete! ðŸ³" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # STAGE 3: DEPLOY TO DEVELOPMENT
  # ============================================
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: build
    environment: development
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to Development
        run: |
          echo "ðŸš€ DEPLOYING TO DEVELOPMENT"
          echo "================================"
          echo "Environment: development"
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          echo "Commit: ${{ github.sha }}"
          echo "Deployed by: ${{ github.actor }}"
          echo "Deploy var: ${{ vars.DEPLOY_ENVIRONMENT }}"
          echo ""
          echo "Simulating deployment..."
          sleep 3
          echo ""
          echo "âœ… DEVELOPMENT DEPLOYMENT SUCCESSFUL"
      
      - name: Run smoke tests
        run: |
          echo "Running smoke tests against development..."
          echo "âœ… Health check passed"
          echo "âœ… API responding"
          echo "âœ… All smoke tests passed"
      
      - name: Post deployment summary
        run: |
          echo "### Development Deployment ðŸŸ¢" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Development |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Actor | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # STAGE 4: DEPLOY TO PRODUCTION (WITH APPROVAL)
  # ============================================
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-dev
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Pre-deployment checks
        run: |
          echo "ðŸ” Running pre-deployment checks..."
          echo "âœ… Development deployment verified"
          echo "âœ… No active incidents"
          echo "âœ… Ready for production deployment"
      
      - name: Deploy to Production
        run: |
          echo "ðŸš€ DEPLOYING TO PRODUCTION"
          echo "================================"
          echo "Environment: production"
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          echo "Commit: ${{ github.sha }}"
          echo "Approved by: ${{ github.actor }}"
          echo ""
          echo "Simulating production deployment..."
          sleep 5
          echo ""
          echo "âœ… PRODUCTION DEPLOYMENT SUCCESSFUL"
      
      - name: Run production smoke tests
        run: |
          echo "Running production smoke tests..."
          echo "âœ… Health check passed"
          echo "âœ… Database connectivity OK"
          echo "âœ… External services OK"
          echo "âœ… All production checks passed"
      
      - name: Post deployment summary
        run: |
          echo "### Production Deployment ðŸŸ¢" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Production |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Approved by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify team
        run: |
          echo "ðŸ“¢ Sending deployment notification..."
          echo "Would notify: Slack, Teams, Email"
          echo "âœ… Team notified of successful deployment"
